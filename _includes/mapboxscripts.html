<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZ3VlcmN1c2d1byIsImEiOiJja29vYTVmdXIwMnJjMm5vanBrb2dwZmp1In0.GFGEzzSYk1QNXmqJ-9lhjA';
var map = new mapboxgl.Map({
	container: 'map', // container ID
	style: 'mapbox://styles/guercusguo/ckqc3h3i600gu18pgwzh0qpjt', // style URL
	// mapbox://styles/guercusguo/ckqc3h3i600gu18pgwzh0qpjt - SAT
	// mapbox://styles/guercusguo/ckrc5h3ak03s518scu3lsusbn - TOPO
	center: [8.39015,45.05038], // starting position
	zoom: 12 // starting zoom
	// pitch: 85,
	// bearing: 80,
});
// chapters on map
var chapters = {
	'monferrato-infernot': {
		bearing: 27,
		center: [8.39015,45.05038],
		zoom: 12,
		pitch: 20
	},
	'canelli-spumante': {
		duration: 6000,
		center: [8.247222,44.740324],
		bearing: 150,
		zoom: 12,
		pitch: 0
	},
	'langa-barolo': {
		bearing: 90,
		center: [7.96339,44.61254],
		zoom: 12,
		speed: 0.6,
		pitch: 40
	},
};

var layerList = document.getElementById('menu');
var inputs = layerList.getElementsByTagName('input');
var fallbackImageUrl = '/../assets/markers/pink-marker.png';
// Chapter-scrolling: On every scroll event, check which element is on screen
window.onscroll = function () {
	var chapterNames = Object.keys(chapters);
	for (var i = 0; i < chapterNames.length; i++) {
		var chapterName = chapterNames[i];
		if (isElementOnScreen(chapterName)) {
			setActiveChapter(chapterName);
			break;
		}
	}
};

var activeChapterName = 'monferrato-infernot';
function setActiveChapter(chapterName) {
	if (chapterName === activeChapterName) return;

	map.flyTo(chapters[chapterName]);

	document.getElementById(chapterName).setAttribute('class', 'active');
	document.getElementById(activeChapterName).setAttribute('class', '');

	activeChapterName = chapterName;
}

function isElementOnScreen(id) {
	var element = document.getElementById(id);
	var bounds = element.getBoundingClientRect();
	return bounds.top < window.innerHeight && bounds.bottom > 0;
}
// End of chapter-scrolling

//Load of GeoJSON data
var geojson;
function addSource() {
	map.addSource('vitivinicoli_aree', {
		'type': 'geojson',
		'data': '/../assets/json/areas.geojson'
	});
	map.addSource('vitivinicoli_linee', {
		'type': 'geojson',
		'data': '/../assets/json/lines.geojson'
	});
	map.addSource('vitivinicoli_punti', {
		'type': 'geojson',
		'data': '/../assets/json/areas.geojson'
	});
	// Mapbox default DEM source
	map.addSource('mapbox-dem', {
		'type': 'raster-dem',
		'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
		'tileSize': 512,
		'maxzoom': 14
	});
} //END of addSource

// List of added layers; rendering and symbology of GeoJSON data.
function addLayer() {
	map.addLayer({
		'id': 'fill_area',
		'type': 'fill',
		'source': 'vitivinicoli_aree', // reference the data source
		'layout': {
			// Make the layer visible by default.
			'visibility': 'visible'
		},
		'paint': {
			'fill-color': [
				'match',
				['get', 'TIPO'],
				'Buffer zone',
				'#feebe2',
				'Core zone',
				'#f768a1',
				'#ccc'
			],
			//'fill-color': '#0080ff', // blue color fill
			'fill-opacity': 0.5
		}
	});
	// Add a black outline around the polygon.
	map.addLayer({
		'id': 'outline_area',
		'type': 'line',
		'source': 'vitivinicoli_aree',
		'layout': {
			// Make the layer visible by default.
			'visibility': 'visible'
		},
		'paint': {
			'line-color': '#000',
			'line-width': 1
		}
	});

	map.addLayer({
		'id': 'path',
		'type': 'line',
		'source': 'vitivinicoli_linee',
		'layout': {
			'visibility':'visible'
		},
		'paint': {
			'line-color': '#ff0000',
			'line-width': 3
		}
	});
	map.addLayer({
		'id': 'enoteche_regionali',
		'type': 'symbol',
		'layout': {
			// Make the layer visible by default.
			'icon-image': 'pink-marker',
			'visibility': 'visible'
			/*'text-field': [
			'format',
			['get', 'Denominaz'],
			{ 'font-scale': 0.8 },
			'\n',
			{},
		],
		'text-font': [
		'Open Sans Semibold',
		'Arial Unicode MS Bold'],
		'text-offset': [0, 1.25],
		'text-anchor': 'top'*/
	},
	'source': 'vitivinicoli_punti',
	// 'paint': {
	// make circles larger as the user zooms from z12 to z22
	// 'circle-radius': {
	// 'base': 3.5,
	// 'stops': [
	// [12, 2],
	// [22, 180]
	// ]
	// },
	// https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match
	// 'circle-color': [
	// 'match',
	// ['get', 'Provincia'],
	// 'AL',
	// '#fbb03b',
	// 'AT',
	// '#223b53',
	// other '#ccc']
	// }
});
map.addLayer({
	'id': 'sky',
	'type': 'sky',
	'paint': {
		'sky-type': 'atmosphere',
		'sky-atmosphere-sun': [0.0, 0.0],
		'sky-atmosphere-sun-intensity': 15
	}
});
// 3D properties
map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
// END of 3D properties
}
//END of addLayer

// Markers load and render
function addMarkers () {
	map.on('load', function () {
		// Add an image to use as a custom marker
		map.loadImage(
			'/../assets/markers/pink-marker.png',
			function (error, image) {
				if (error) throw error;
				map.addImage('pink-marker', image);
			}
		);
	});
	// loadImage is async -> images are not rendered when style changes, hence custom markers.
	// Still has problems with certain zooms
	map.on('styleimagemissing', function (e) {
		map.loadImage(fallbackImageUrl, function(err, data) {
			if (!err) {
				if (!map.hasImage(e.id)) {
					map.addImage(e.id, data);
				}
			}
		});
	});
}
// Fallback for sprites / markers not loading when changing styles

// END of Markers load and render

// Basemap switch
map.on('style.load', function() {
	addMarkers();
	addSource();
	addLayer();
});
// After the last frame rendered before the map enters an "idle" state.
/*	map.on('idle', function () {
// If these two layers have been added to the style,
// add the toggle buttons.
if (map.getLayer('fill_area') && map.getLayer('outline_area') && map.getLayer('path') && map.getLayer('cascine')) {
// Enumerate ids of the layers.
var toggleableLayerIds = ['fill_area', 'outline_area','path','cascine'];
// Set up the corresponding toggle button for each layer.
for (var i = 0; i < toggleableLayerIds.length; i++) {
var id = toggleableLayerIds[i];
if (!document.getElementById(id)) {
// Create a link.
var link = document.createElement('a');
link.id = id;
link.href = '#';
link.textContent = id;
link.className = 'active';
// Show or hide layer when the toggle is clicked.
link.onclick = function (e) {
var clickedLayer = this.textContent;
e.preventDefault();
e.stopPropagation();

var visibility = map.getLayoutProperty(
clickedLayer,
'visibility'
);

// Toggle layer visibility by changing the layout object's visibility property.
if (visibility === 'visible') {
map.setLayoutProperty(
clickedLayer,
'visibility',
'none'
);
this.className = '';
} else {
this.className = 'active';
map.setLayoutProperty(
clickedLayer,
'visibility',
'visible'
);
}
};

var layers = document.getElementById('layerswitch');
layers.appendChild(link);
}
}
}
});*/
function switchLayer(layer) {
	var layerId = layer.target.id;
	map.setStyle('mapbox://styles/guercusguo/' + layerId);
};
for (var i = 0; i < inputs.length; i++) {
	inputs[i].onclick = switchLayer; }
	// still incomplete
	// End of Basemap switch
	map.addControl(new mapboxgl.NavigationControl());

	// START of popup on click for pointal features
	map.on('load', function () {
		map.on('click', 'enoteche_regionali', function (e) {
			var coordinates = e.features[0].geometry.coordinates.slice();
			var description = e.features[0].properties.Denominaz;

			// Ensure that if the map is zoomed out such that multiple
			// copies of the feature are visible, the popup appears
			// over the copy being pointed to.
			while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
				coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
			}

			new mapboxgl.Popup()
			.setLngLat(coordinates)
			.setHTML(description)
			.addTo(map);
		});

		// Change the cursor to a pointer when the mouse is over the places layer.
		map.on('mouseenter', 'enoteche_regionali', function () {
			map.getCanvas().style.cursor = 'pointer';
		});

		// Change it back to a pointer when it leaves.
		map.on('mouseleave', 'enoteche_regionali', function () {
			map.getCanvas().style.cursor = '';
		});
	});
	// END of popup on click for pointal features

	// Return to map extent
	document.getElementById('fit').addEventListener('click', function () {
		map.fitBounds([
			[7.798595, 44.523151], // southwestern corner of the bounds
			[8.571995, 45.121761] // northeastern corner of the bounds
		]);
	});
	// END of Return to map extent
</script>
